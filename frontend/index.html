<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Which Quote? - Voice Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100">
            <div class="container mx-auto px-4 py-8 max-w-6xl">
                <!-- Header -->
                <div class="text-center mb-12">
                    <h1 class="text-5xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-3">
                        <i class="fas fa-quote-left text-indigo-600"></i>
                        Which Quote?
                    </h1>
                    <p class="text-gray-600 text-lg">Ask for wisdom using your voice or text</p>
                </div>

                <!-- Mode Toggle -->
                <div class="flex justify-center mb-8">
                    <div class="bg-white rounded-full p-1 shadow-md">
                        <button
                            @click="mode = 'voice'"
                            :class="[
                                'px-6 py-2 rounded-full transition-all',
                                mode === 'voice' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                            ]"
                        >
                            <i class="fas fa-microphone mr-2"></i>
                            Voice
                        </button>
                        <button
                            @click="mode = 'text'"
                            :class="[
                                'px-6 py-2 rounded-full transition-all',
                                mode === 'text' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                            ]"
                        >
                            <i class="fas fa-search mr-2"></i>
                            Text
                        </button>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Main Interface -->
                    <div class="md:col-span-2">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <!-- Voice Mode -->
                            <div v-if="mode === 'voice'" class="text-center">
                                <button
                                    @click="toggleRecording"
                                    :disabled="isProcessing"
                                    :class="[
                                        'w-40 h-40 rounded-full flex items-center justify-center mx-auto mb-6 transition-all transform hover:scale-105 shadow-2xl',
                                        isRecording ? 'bg-red-500 hover:bg-red-600 animate-pulse' :
                                        isProcessing ? 'bg-gray-400 cursor-not-allowed' :
                                        'bg-indigo-600 hover:bg-indigo-700'
                                    ]"
                                >
                                    <i v-if="isProcessing" class="fas fa-spinner fa-spin text-white text-6xl"></i>
                                    <i v-else-if="isRecording" class="fas fa-microphone-slash text-white text-6xl"></i>
                                    <i v-else class="fas fa-microphone text-white text-6xl"></i>
                                </button>

                                <p class="text-gray-600 mb-4">
                                    {{ isRecording ? 'Recording... Click to stop' :
                                       isProcessing ? 'Processing your query...' :
                                       'Click to start recording' }}
                                </p>
                            </div>

                            <!-- Text Mode -->
                            <div v-else>
                                <div class="flex gap-2 mb-6">
                                    <input
                                        v-model="textQuery"
                                        @keypress.enter="processTextQuery"
                                        type="text"
                                        placeholder="Ask about love, wisdom, courage..."
                                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        :disabled="isProcessing"
                                    />
                                    <button
                                        @click="processTextQuery"
                                        :disabled="isProcessing || !textQuery.trim()"
                                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                                    >
                                        <i v-if="isProcessing" class="fas fa-spinner fa-spin"></i>
                                        <i v-else class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Results Display -->
                            <div v-if="transcription" class="space-y-4 mt-8">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-sm text-blue-600 font-semibold mb-1">Your Query:</p>
                                    <p class="text-gray-800">{{ transcription }}</p>
                                </div>

                                <div v-if="response" class="bg-purple-50 p-4 rounded-lg">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm text-purple-600 font-semibold mb-1">Response:</p>
                                            <p class="text-gray-800">{{ response }}</p>
                                        </div>
                                        <button
                                            @click="playResponseAudio"
                                            class="ml-4 p-2 text-purple-600 hover:bg-purple-100 rounded-full transition-colors"
                                        >
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                    </div>
                                </div>

                                <div v-if="quoteData" class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-lg border-l-4 border-indigo-600">
                                    <i class="fas fa-quote-left text-indigo-600 text-2xl mb-2"></i>
                                    <p class="text-gray-800 text-lg italic mb-3">"{{ quoteData.text }}"</p>
                                    <p class="text-gray-600">
                                        — <span class="font-semibold">{{ quoteData.author }}</span>
                                        <span v-if="quoteData.work" class="text-sm"> ({{ quoteData.work }})</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="space-y-6">
                        <!-- Speaker Registration -->
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-user"></i>
                                Speaker ID
                            </h3>
                            <input
                                v-model="speakerId"
                                type="text"
                                placeholder="Your name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <button
                                @click="registerSpeaker"
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                            >
                                <i class="fas fa-user-plus mr-2"></i>
                                Register Voice
                            </button>
                        </div>

                        <!-- History -->
                        <div class="bg-white rounded-2xl shadow-xl p-6 max-h-96 overflow-y-auto">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Queries</h3>
                            <div v-if="history.length === 0" class="text-gray-500 text-sm">
                                No queries yet
                            </div>
                            <div v-else class="space-y-3">
                                <div
                                    v-for="(item, idx) in history"
                                    :key="idx"
                                    class="border-b border-gray-200 pb-3"
                                >
                                    <p class="text-xs text-gray-500">{{ item.timestamp }}</p>
                                    <p class="text-sm text-gray-700 font-medium">{{ item.query }}</p>
                                    <p v-if="item.quote" class="text-xs text-indigo-600 mt-1">
                                        — {{ item.quote.author }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- API Status -->
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">API Status</h3>
                            <div class="flex items-center gap-2">
                                <div :class="['w-3 h-3 rounded-full', apiStatus ? 'bg-green-500' : 'bg-red-500']"></div>
                                <span class="text-sm text-gray-600">
                                    {{ apiStatus ? 'Connected' : 'Disconnected' }}
                                </span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">{{ apiUrl }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden audio element -->
        <audio ref="audioPlayer"></audio>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    apiUrl: 'http://localhost:8000/api/v1',
                    mode: 'voice',
                    isRecording: false,
                    isProcessing: false,
                    transcription: '',
                    response: '',
                    quoteData: null,
                    speakerId: '',
                    history: [],
                    textQuery: '',
                    apiStatus: false,
                    mediaRecorder: null,
                    audioChunks: [],
                    responseAudioUrl: null
                };
            },
            mounted() {
                this.requestMicrophonePermission();
                this.checkApiStatus();
            },
            methods: {
                async requestMicrophonePermission() {
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                        console.log('Microphone access granted');
                    } catch (error) {
                        console.error('Microphone access denied:', error);
                    }
                },

                async checkApiStatus() {
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/speaker/list/`);
                        this.apiStatus = response.ok;
                    } catch (error) {
                        this.apiStatus = false;
                    }
                },

                async startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.mediaRecorder = new MediaRecorder(stream);
                        this.audioChunks = [];

                        this.mediaRecorder.ondataavailable = (event) => {
                            this.audioChunks.push(event.data);
                        };

                        this.mediaRecorder.onstop = async () => {
                            const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                            await this.processVoiceQuery(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };

                        this.mediaRecorder.start();
                        this.isRecording = true;
                    } catch (error) {
                        console.error('Error starting recording:', error);
                        alert('Could not access microphone. Please ensure permissions are granted.');
                    }
                },

                stopRecording() {
                    if (this.mediaRecorder && this.isRecording) {
                        this.mediaRecorder.stop();
                        this.isRecording = false;
                    }
                },

                toggleRecording() {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                },

                async processVoiceQuery(audioBlob) {
                    this.isProcessing = true;

                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'query.wav');

                    try {
                        const response = await fetch(`${this.apiUrl}/voice/query/`, {
                            method: 'POST',
                            body: formData,
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.transcription = data.transcription;
                            this.response = data.response_text;
                            this.quoteData = data.quote_data;

                            this.addToHistory({
                                query: data.transcription,
                                response: data.response_text,
                                quote: data.quote_data,
                                timestamp: new Date().toLocaleTimeString()
                            });

                            if (data.response_audio) {
                                this.playAudioFromBase64(data.response_audio);
                            }
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error processing voice query:', error);
                        alert('Failed to process voice query. Make sure the Django server is running.');
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async processTextQuery() {
                    if (!this.textQuery.trim()) return;

                    this.isProcessing = true;

                    try {
                        // Search for quote
                        const searchResponse = await fetch(
                            `${this.apiUrl}/quotes/search/?q=${encodeURIComponent(this.textQuery)}`
                        );
                        const searchData = await searchResponse.json();

                        const quote = searchData.results && searchData.results.length > 0 
                            ? searchData.results[0] 
                            : null;

                        let responseText;
                        if (quote) {
                            responseText = `${quote.author} once said: ${quote.text}`;
                        } else {
                            responseText = "I couldn't find a relevant quote for that query.";
                        }

                        this.transcription = this.textQuery;
                        this.response = responseText;
                        this.quoteData = quote;

                        this.addToHistory({
                            query: this.textQuery,
                            response: responseText,
                            quote: quote,
                            timestamp: new Date().toLocaleTimeString()
                        });

                        // Synthesize speech
                        const ttsResponse = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: responseText })
                        });

                        if (ttsResponse.ok) {
                            const audioBlob = await ttsResponse.blob();
                            this.responseAudioUrl = URL.createObjectURL(audioBlob);
                            this.$refs.audioPlayer.src = this.responseAudioUrl;
                            this.$refs.audioPlayer.play();
                        }

                        this.textQuery = '';
                    } catch (error) {
                        console.error('Error processing text query:', error);
                        alert('Failed to process query. Make sure the Django server is running.');
                    } finally {
                        this.isProcessing = false;
                    }
                },

                playAudioFromBase64(base64Audio) {
                    const audioBlob = this.base64ToBlob(base64Audio, 'audio/wav');
                    this.responseAudioUrl = URL.createObjectURL(audioBlob);
                    this.$refs.audioPlayer.src = this.responseAudioUrl;
                    this.$refs.audioPlayer.play();
                },

                playResponseAudio() {
                    if (this.$refs.audioPlayer) {
                        this.$refs.audioPlayer.play();
                    }
                },

                base64ToBlob(base64, mimeType) {
                    const byteCharacters = atob(base64);
                    const byteArrays = [];

                    for (let i = 0; i < byteCharacters.length; i += 512) {
                        const slice = byteCharacters.slice(i, i + 512);
                        const byteNumbers = new Array(slice.length);

                        for (let j = 0; j < slice.length; j++) {
                            byteNumbers[j] = slice.charCodeAt(j);
                        }

                        byteArrays.push(new Uint8Array(byteNumbers));
                    }

                    return new Blob(byteArrays, { type: mimeType });
                },

                addToHistory(item) {
                    this.history = [item, ...this.history].slice(0, 10);
                },

                async registerSpeaker() {
                    if (!this.speakerId.trim()) {
                        alert('Please enter a speaker ID');
                        return;
                    }

                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mediaRecorder = new MediaRecorder(stream);
                        const chunks = [];

                        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

                        mediaRecorder.onstop = async () => {
                            const audioBlob = new Blob(chunks, { type: 'audio/wav' });
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'speaker.wav');
                            formData.append('speaker_id', this.speakerId);

                            const response = await fetch(`${this.apiUrl}/voice/speaker/register/`, {
                                method: 'POST',
                                body: formData,
                            });

                            const data = await response.json();
                            if (data.success) {
                                alert(`Speaker "${this.speakerId}" registered successfully!`);
                                this.speakerId = '';
                            } else {
                                alert('Registration failed: ' + data.error);
                            }

                            stream.getTracks().forEach(track => track.stop());
                        };

                        alert('Recording for 3 seconds... Please speak naturally.');
                        mediaRecorder.start();
                        setTimeout(() => mediaRecorder.stop(), 3000);
                    } catch (error) {
                        console.error('Error registering speaker:', error);
                        alert('Failed to register speaker');
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>