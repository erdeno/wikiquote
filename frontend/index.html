<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Which Quote? - Voice Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chat-float-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-float-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .chat-popup {
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f9fafb;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-message.assistant .message-avatar {
            background: #e5e7eb;
            color: #6b7280;
        }

        .message-content {
            max-width: 70%;
            position: relative;
        }

        .chat-message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px 16px 4px 16px;
            padding: 12px 16px;
        }

        .chat-message.assistant .message-content {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px 16px 16px 4px;
            padding: 12px 16px;
        }

        .message-text {
            margin: 0;
            line-height: 1.5;
            font-size: 14px;
        }

        .message-time {
            font-size: 10px;
            color: rgba(0, 0, 0, 0.4);
            display: block;
            margin-top: 4px;
        }

        .chat-message.user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .quote-card {
            background: #f3f4f6;
            border-left: 3px solid #6366f1;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
        }

        .similarity-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-top: 4px;
            font-weight: 600;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .quick-questions-container {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .quick-question-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quick-question-btn:hover {
            background: #e5e7eb;
            border-color: #6366f1;
        }

        .chat-input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
        }

        .chat-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-record-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }

        .voice-record-btn:hover {
            transform: scale(1.1);
        }

        .voice-record-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }

        .chat-settings-footer {
            padding: 8px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        /* Animation */
        .slide-up-enter-active, .slide-up-leave-active {
            transition: all 0.3s ease;
        }

        .slide-up-enter-from {
            transform: translateY(20px);
            opacity: 0;
        }

        .slide-up-leave-to {
            transform: translateY(20px);
            opacity: 0;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .chat-popup {
                width: calc(100vw - 40px);
                height: calc(100vh - 100px);
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100">
            <div class="container mx-auto px-4 py-8 max-w-6xl">
                <!-- Header -->
                <!-- Header with User Info -->
                <div class="flex justify-between items-center mb-12">
                    <div class="text-center flex-1">
                        <h1 class="text-5xl font-bold text-gray-800 mb-4 flex items-center justify-center gap-3">
                            <i class="fas fa-quote-left text-indigo-600"></i>
                            Which Quote?
                        </h1>
                        <p class="text-gray-600 text-lg">Ask for wisdom using your voice or text</p>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="relative">
                        <button
                            @click="showUserMenu = !showUserMenu"
                            class="flex items-center gap-3 bg-white rounded-full px-4 py-2 shadow-lg hover:shadow-xl transition-all"
                        >
                            <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
                                {{ userInitials }}
                            </div>
                            <div class="text-left hidden md:block">
                                <p class="text-sm font-semibold text-gray-800">{{ userName }}</p>
                                <p class="text-xs text-gray-500">{{ userQueries }} queries</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div
                            v-if="showUserMenu"
                            class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl py-2 z-50"
                        >
                            <div class="px-4 py-3 border-b">
                                <p class="text-sm font-semibold">{{ user.username }}</p>
                                <p class="text-xs text-gray-500">{{ user.email }}</p>
                            </div>
                            <button
                                @click="showProfileModal = true; showUserMenu = false"
                                class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-3"
                            >
                                <i class="fas fa-user"></i>
                                Profile Settings
                            </button>
                            <button
                                @click="handleLogout"
                                class="w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600 flex items-center gap-3"
                            >
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mode Toggle -->
                <div class="flex justify-center mb-8">
                    <div class="bg-white rounded-full p-1 shadow-md">
                        <button
                            @click="mode = 'voice'"
                            :class="[
                                'px-6 py-2 rounded-full transition-all',
                                mode === 'voice' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                            ]"
                        >
                            <i class="fas fa-microphone mr-2"></i>
                            Voice
                        </button>
                        <button
                            @click="mode = 'text'"
                            :class="[
                                'px-6 py-2 rounded-full transition-all',
                                mode === 'text' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                            ]"
                        >
                            <i class="fas fa-search mr-2"></i>
                            Text
                        </button>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Main Interface -->
                    <div class="md:col-span-2">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <!-- Voice Mode -->
                            <div v-if="mode === 'voice'" class="text-center">
                                <button
                                    @click="toggleRecording"
                                    :disabled="isProcessing"
                                    :class="[
                                        'w-40 h-40 rounded-full flex items-center justify-center mx-auto mb-6 transition-all transform hover:scale-105 shadow-2xl',
                                        isRecording ? 'bg-red-500 hover:bg-red-600 animate-pulse' :
                                        isProcessing ? 'bg-gray-400 cursor-not-allowed' :
                                        'bg-indigo-600 hover:bg-indigo-700'
                                    ]"
                                >
                                    <i v-if="isProcessing" class="fas fa-spinner fa-spin text-white text-6xl"></i>
                                    <i v-else-if="isRecording" class="fas fa-microphone-slash text-white text-6xl"></i>
                                    <i v-else class="fas fa-microphone text-white text-6xl"></i>
                                </button>

                                <p class="text-gray-600 mb-4">
                                    {{ isRecording ? 'Recording... Click to stop' :
                                       isProcessing ? 'Processing your query...' :
                                       'Click to start recording' }}
                                </p>
                            </div>

                            <!-- Text Mode -->
                            <div v-else>
                                <div class="flex gap-2 mb-6">
                                    <!-- Wrap input in relative container for dropdown positioning -->
                                    <div class="flex-1 relative">
                                        <input
                                            v-model="textQuery"
                                            @keypress.enter="processTextQuery"
                                            @blur="hideAutocomplete"
                                            @focus="textQuery.length >= 2 && fetchAutocompleteSuggestions()"
                                            type="text"
                                            placeholder="Ask about love, wisdom, courage..."
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            :disabled="isProcessing"
                                        />
                                        
                                        <!-- Autocomplete Dropdown -->
                                        <div 
                                            v-if="showAutocomplete" 
                                            class="absolute z-50 w-full mt-2 bg-white border border-gray-200 rounded-lg shadow-xl max-h-80 overflow-y-auto"
                                        >
                                            <div v-if="isLoadingSuggestions" class="p-4 text-center text-gray-500">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                                Searching quotes...
                                            </div>
                                            
                                            <div v-else-if="autocompleteSuggestions.length === 0" class="p-4 text-center text-gray-500">
                                                No quotes found
                                            </div>
                                            
                                            <div v-else>
                                                <div
                                                    v-for="(quote, index) in autocompleteSuggestions"
                                                    :key="index"
                                                    @mousedown="selectSuggestion(quote)"
                                                    class="p-4 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                                                >
                                                    <p class="text-gray-800 italic mb-2">
                                                        "{{ quote.text.length > 100 ? quote.text.substring(0, 100) + '...' : quote.text }}"
                                                    </p>
                                                    <p class="text-sm text-indigo-600 font-semibold">
                                                        — {{ quote.author }}
                                                        <span v-if="quote.work" class="text-gray-500 font-normal">({{ quote.work }})</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button
                                        @click="processTextQuery"
                                        :disabled="isProcessing || !textQuery.trim()"
                                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                                    >
                                        <i v-if="isProcessing" class="fas fa-spinner fa-spin"></i>
                                        <i v-else class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Results Display -->
                            <div v-if="transcription" class="space-y-4 mt-8">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <p class="text-sm text-blue-600 font-semibold mb-1">Your Query:</p>
                                    <p class="text-gray-800">{{ transcription }}</p>
                                </div>

                                <div v-if="response" class="bg-purple-50 p-4 rounded-lg">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm text-purple-600 font-semibold mb-1">Response:</p>
                                            <p class="text-gray-800">{{ response }}</p>
                                        </div>
                                        <button
                                            @click="playResponseAudio"
                                            class="ml-4 p-2 text-purple-600 hover:bg-purple-100 rounded-full transition-colors"
                                        >
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                    </div>
                                </div>

                                <div v-if="quoteData" class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-lg border-l-4 border-indigo-600">
                                    <i class="fas fa-quote-left text-indigo-600 text-2xl mb-2"></i>
                                    <p class="text-gray-800 text-lg italic mb-3">"{{ quoteData.text }}"</p>
                                    <p class="text-gray-600">
                                        — <span class="font-semibold">{{ quoteData.author }}</span>
                                        <span v-if="quoteData.work" class="text-sm"> ({{ quoteData.work }})</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="space-y-6">
                        <!-- Speaker Registration -->
                        <!-- Accent Preferences (Simplified) -->
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-globe"></i>
                                Voice Preferences
                            </h3>
                            
                            <p class="text-sm text-gray-600 mb-4">
                                Choose your preferred accent for voice responses
                            </p>
                            
                            <!-- Current Selection Display -->
                            <div v-if="user?.profile?.tts_voice_type" class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">{{ getAccentFlag(user.profile.tts_voice_type) }}</span>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800">
                                                {{ getAccentName(user.profile.tts_voice_type) }}
                                            </p>
                                            <p class="text-xs text-gray-500">Current accent</p>
                                        </div>
                                    </div>
                                    <button
                                        @click="testCurrentAccent"
                                        class="px-3 py-1 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"
                                    >
                                        <i class="fas fa-play mr-1"></i>
                                        Test
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Accent Selection Grid -->
                            <div class="mb-4">
                                <label class="text-sm font-semibold text-gray-700 mb-3 block">
                                    Select Accent
                                </label>
                                
                                <div class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto">
                                    <div
                                        v-for="accent in availableAccents"
                                        :key="accent.id"
                                        @click="selectAccent(accent.id)"
                                        :class="[
                                            'p-3 rounded-lg border-2 cursor-pointer transition-all hover:shadow-md',
                                            ttsPreferences.accent === accent.id 
                                                ? 'border-indigo-600 bg-indigo-50' 
                                                : 'border-gray-200 hover:border-indigo-300'
                                        ]"
                                    >
                                        <div class="text-center">
                                            <div class="text-3xl mb-1">{{ accent.flag }}</div>
                                            <p class="text-xs font-semibold text-gray-800">{{ accent.name }}</p>
                                            <p class="text-xs text-gray-500">{{ accent.lang }}</p>
                                            <button
                                                @click.stop="testSpecificAccent(accent.id)"
                                                class="mt-2 w-full py-1 px-2 bg-indigo-100 hover:bg-indigo-200 rounded text-xs transition-colors"
                                            >
                                                <i class="fas fa-play text-indigo-600"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Optional: Advanced Settings (Collapsed) -->
                            <details class="mt-4">
                                <summary class="text-sm font-semibold text-gray-700 cursor-pointer hover:text-indigo-600">
                                    <i class="fas fa-sliders-h mr-2"></i>
                                    Advanced Settings
                                </summary>
                                
                                <div class="mt-3 space-y-3">
                                    <div>
                                        <label class="text-xs text-gray-600 flex items-center gap-2">
                                            <i class="fas fa-music"></i>
                                            Pitch: {{ ttsPreferences.pitch.toFixed(1) }}
                                        </label>
                                        <input
                                            v-model.number="ttsPreferences.pitch"
                                            type="range"
                                            min="0.5"
                                            max="2.0"
                                            step="0.1"
                                            class="w-full"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs text-gray-600 flex items-center gap-2">
                                            <i class="fas fa-tachometer-alt"></i>
                                            Speed: {{ ttsPreferences.speed.toFixed(1) }}
                                        </label>
                                        <input
                                            v-model.number="ttsPreferences.speed"
                                            type="range"
                                            min="0.5"
                                            max="2.0"
                                            step="0.1"
                                            class="w-full"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs text-gray-600 flex items-center gap-2">
                                            <i class="fas fa-bolt"></i>
                                            Energy: {{ ttsPreferences.energy.toFixed(1) }}
                                        </label>
                                        <input
                                            v-model.number="ttsPreferences.energy"
                                            type="range"
                                            min="0.5"
                                            max="2.0"
                                            step="0.1"
                                            class="w-full"
                                        />
                                    </div>
                                </div>
                            </details>
                            
                            <!-- Save Button -->
                            <button
                                @click="saveAccentPreferences"
                                class="w-full mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                :disabled="!hasPreferenceChanges"
                                :class="{'opacity-50 cursor-not-allowed': !hasPreferenceChanges}"
                            >
                                <i class="fas fa-save mr-2"></i>
                                Save Preferences
                            </button>
                        </div>

                        <!-- History -->
                        <div class="bg-white rounded-2xl shadow-xl p-6 max-h-96 overflow-y-auto">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Queries</h3>
                            <div v-if="history.length === 0" class="text-gray-500 text-sm">
                                No queries yet
                            </div>
                            <div v-else class="space-y-3">
                                <div
                                    v-for="(item, idx) in history"
                                    :key="idx"
                                    class="border-b border-gray-200 pb-3"
                                >
                                    <p class="text-xs text-gray-500">{{ item.timestamp }}</p>
                                    <p class="text-sm text-gray-700 font-medium">{{ item.query }}</p>
                                    <p v-if="item.quote" class="text-xs text-indigo-600 mt-1">
                                        — {{ item.quote.author }}
                                    </p>
                                </div>
                            </div>
                        </div>

			<!-- API Status -->
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">System Status</h3>
                        
                            <!-- Backend API Status -->
                            <div class="mb-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Backend API</span>
                                    <div class="flex items-center gap-2">
                                        <div :class="['w-3 h-3 rounded-full', apiStatus ? 'bg-green-500' : 'bg-red-500']"></div>
                                        <span class="text-sm text-gray-600">
                                            {{ apiStatus ? 'Connected' : 'Disconnected' }}
                                        </span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">{{ apiUrl }}</p>
                            </div>
                        
                            <!-- Ollama Status -->
                            <div class="pt-3 border-t border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Ollama LLM</span>
                                    <div class="flex items-center gap-2">
                                        <div :class="['w-3 h-3 rounded-full', ollamaStatus ? 'bg-green-500' : 'bg-red-500']"></div>
                                        <span class="text-sm text-gray-600">
                                            {{ ollamaStatus ? 'Connected' : 'Disconnected' }}
                                        </span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">
                                    {{ apiUrl.includes('localhost') ? 'localhost:11434' : 'wikiquote-ollama:11434' }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div
            v-if="showProfileModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            @click.self="showProfileModal = false"
        >
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-cog mr-2 text-indigo-600"></i>
                            Profile Settings
                        </h2>
                        <button
                            @click="showProfileModal = false"
                            class="text-gray-500 hover:text-gray-700"
                        >
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- User Info -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Account Information</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Username</label>
                                <p class="font-semibold">{{ user?.username }}</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Email</label>
                                <p class="font-semibold">{{ user?.email }}</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Total Queries</label>
                                <p class="font-semibold">{{ user?.profile?.queries_count || 0 }}</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Voice Status</label>
                                <p :class="[
                                    'font-semibold',
                                    user?.profile?.voice_registered ? 'text-green-600' : 'text-gray-500'
                                ]">
                                    <i :class="[
                                        'fas mr-1',
                                        user?.profile?.voice_registered ? 'fa-check-circle' : 'fa-times-circle'
                                    ]"></i>
                                    {{ user?.profile?.voice_registered ? 'Registered' : 'Not Registered' }}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice Preferences -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Voice Preferences</h3>
                        
                        <!-- Current Voice Display -->
                        <div v-if="user?.profile?.voice_registered" class="mb-4 p-4 bg-indigo-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Current Voice Settings</p>
                            <div class="flex items-center gap-3">
                                <i :class="[
                                    'fas text-2xl',
                                    user?.profile?.tts_voice_type?.startsWith('male') ? 'fa-mars text-blue-600' : 'fa-venus text-pink-600'
                                ]"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">
                                        {{ user?.profile?.tts_voice_type?.replace('_', ' ').toUpperCase() }}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        Pitch: {{ user?.profile?.tts_pitch }} | 
                                        Speed: {{ user?.profile?.tts_speed }} | 
                                        Energy: {{ user?.profile?.tts_energy }}
                                    </p>
                                </div>
                                <button
                                    @click="testCurrentVoice"
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm"
                                >
                                    <i class="fas fa-play mr-1"></i>
                                    Test
                                </button>
                            </div>
                        </div>
                        
                        <!-- Update Preferences -->
                        <button
                            @click="loadCurrentPreferences"
                            class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                        >
                            <i class="fas fa-edit mr-2"></i>
                            Update Voice Preferences
                        </button>
                    </div>
                    
                    <!-- Statistics -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Statistics</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <i class="fas fa-microphone text-2xl text-blue-600 mb-2"></i>
                                <p class="text-2xl font-bold text-blue-600">{{ history.length }}</p>
                                <p class="text-xs text-gray-600">This Session</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <i class="fas fa-quote-right text-2xl text-green-600 mb-2"></i>
                                <p class="text-2xl font-bold text-green-600">{{ user?.profile?.queries_count || 0 }}</p>
                                <p class="text-xs text-gray-600">Total Queries</p>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <i class="fas fa-clock text-2xl text-purple-600 mb-2"></i>
                                <p class="text-sm font-bold text-purple-600">
                                    {{ formatDate(user?.profile?.last_query) }}
                                </p>
                                <p class="text-xs text-gray-600">Last Query</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add this component to your existing HTML, before the closing </div> of #app -->

        <!-- Chatbot Popup Component -->
        <div v-if="showChatbot || chatOpen" class="chatbot-container">
            <!-- Floating Chat Button -->
            <button
                v-if="!chatOpen"
                @click="openChat"
                class="chat-float-button"
                title="Chat with Quote Assistant"
            >
                <i class="fas fa-robot text-2xl"></i>
                <span v-if="unreadMessages > 0" class="chat-badge">{{ unreadMessages }}</span>
            </button>

            <!-- Chat Popup -->
            <transition name="slide-up">
                <div v-if="chatOpen" class="chat-popup">
                    <!-- Header -->
                    <div class="chat-header">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white">Quote Assistant</h3>
                                <p class="text-xs text-indigo-200">Powered by AI</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Mode Toggle -->
                            <button
                                @click="chatMode = chatMode === 'text' ? 'voice' : 'text'"
                                class="chat-header-btn"
                                :title="chatMode === 'text' ? 'Switch to Voice' : 'Switch to Text'"
                            >
                                <i :class="chatMode === 'text' ? 'fas fa-microphone' : 'fas fa-keyboard'"></i>
                            </button>
                            <!-- Clear Chat -->
                            <button
                                @click="clearChatHistory"
                                class="chat-header-btn"
                                title="Clear chat"
                            >
                                <i class="fas fa-trash"></i>
                            </button>
                            <!-- Close -->
                            <button
                                @click="closeChat"
                                class="chat-header-btn"
                                title="Close"
                            >
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div ref="chatMessages" class="chat-messages">
                        <div
                            v-for="(message, index) in chatMessages"
                            :key="index"
                            :class="['chat-message', message.role]"
                        >
                            <div class="message-avatar">
                                <i :class="message.role === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
                            </div>
                            <div class="message-content">
                                <p class="message-text">{{ message.content }}</p>
                                
                                <!-- Display quotes if available -->
                                <div v-if="message.quotes && message.quotes.length > 0" class="mt-3 space-y-2">
                                    <div
                                        v-for="(quote, qIndex) in message.quotes"
                                        :key="qIndex"
                                        class="quote-card"
                                    >
                                        <p class="text-sm italic text-gray-700">
                                            <i class="fas fa-quote-left text-indigo-400 text-xs mr-1"></i>
                                            {{ quote.text }}
                                            <i class="fas fa-quote-right text-indigo-400 text-xs ml-1"></i>
                                        </p>
                                        <p class="text-xs text-gray-600 mt-1">
                                            — <strong>{{ quote.author }}</strong>
                                            <span v-if="quote.work" class="text-gray-500">({{ quote.work }})</span>
                                        </p>
                                        <span v-if="quote.similarity" class="similarity-badge">
                                            {{ (quote.similarity * 100).toFixed(0) }}% match
                                        </span>
                                    </div>
                                </div>
                                
                                <span class="message-time">{{ formatMessageTime(message.timestamp) }}</span>
                            </div>
                        </div>

                        <!-- Typing Indicator -->
                        <div v-if="chatLoading" class="chat-message assistant">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Recording Indicator -->
                        <div v-if="chatRecording" class="chat-message assistant">
                            <div class="message-avatar">
                                <i class="fas fa-microphone text-red-500 animate-pulse"></i>
                            </div>
                            <div class="message-content">
                                <p class="text-red-500 font-semibold">Recording... Click to stop</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Questions (shown when chat is empty) -->
                    <div v-if="chatMessages.length === 1 && !chatLoading" class="quick-questions-container">
                        <p class="text-xs text-gray-500 mb-2">Try asking:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button
                                v-for="(question, idx) in quickQuestions"
                                :key="idx"
                                @click="sendQuickQuestion(question)"
                                class="quick-question-btn"
                            >
                                {{ question }}
                            </button>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="chat-input-container">
                        <!-- Text Mode Input -->
                        <div v-if="chatMode === 'text'" class="flex gap-2">
                            <input
                                v-model="chatInput"
                                @keypress.enter="sendChatMessage"
                                type="text"
                                placeholder="Ask about quotes..."
                                class="chat-input"
                                :disabled="chatLoading"
                                ref="chatInputField"
                            />
                            <button
                                @click="sendChatMessage"
                                :disabled="chatLoading || !chatInput.trim()"
                                class="chat-send-btn"
                            >
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <!-- Voice Mode Input -->
                        <div v-else class="flex items-center justify-center gap-4 py-2">
                            <button
                                @click="toggleChatRecording"
                                :disabled="chatLoading"
                                :class="[
                                    'voice-record-btn',
                                    chatRecording ? 'recording' : ''
                                ]"
                            >
                                <i :class="chatRecording ? 'fas fa-stop' : 'fas fa-microphone'"></i>
                            </button>
                            <p class="text-sm text-gray-600">
                                {{ chatRecording ? 'Recording... Click to stop' : 'Click to start voice input' }}
                            </p>
                        </div>
                    </div>

                    <!-- Settings Footer -->
                    <div class="chat-settings-footer">
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <span>Accent:</span>
                            <select
                                v-model="chatAccent"
                                class="text-xs border rounded px-2 py-1"
                            >
                                <option v-for="accent in availableAccents" :key="accent.id" :value="accent.id">
                                    {{ accent.flag }} {{ accent.name }}
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </transition>
        </div>

        <!-- Hidden audio element -->
        <audio ref="audioPlayer"></audio>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
		    apiUrl: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                	? 'http://localhost:8000/api/v1'
                        : 'http://wikiquote-backend.germanywestcentral.azurecontainer.io:8000/api/v1',
        
                    mode: 'text',
                    isRecording: false,
                    isProcessing: false,
                    transcription: '',
                    response: '',
                    quoteData: null,
                    speakerId: '',
                    history: [],
                    textQuery: '',
		            autocompleteSuggestions: [],
                    showAutocomplete: false,
                    isLoadingSuggestions: false,
                    apiStatus: false,
		    ollamaStatus: false,
                    mediaRecorder: null,
                    audioChunks: [],
                    responseAudioUrl: null,
                    autocompleteTimeout: null,

                    // Chatbot data
                    showChatbot: true,
                    chatOpen: false,
                    chatMode: 'text',
                    chatInput: '',
                    chatMessages: [
                        {
                            role: 'assistant',
                            content: "Hi! I'm your AI quote assistant. Ask me about wisdom, courage, love, or any topic! 💭",
                            timestamp: new Date()
                        }
                    ],
                    chatLoading: false,
                    chatRecording: false,
                    chatAccent: 'american',
                    unreadMessages: 0,
                    chatMediaRecorder: null,
                    chatAudioChunks: [],
                    quickQuestions: [
                        "Tell me about wisdom",
                        "I need motivation",
                        "Quote about love",
                        "Something inspiring"
                    ],
                    
                    // User data
                    user: null,
                    authToken: null,
                    showUserMenu: false,
                    showProfileModal: false,
                    
                    // TTS Preferences
                    ttsPreferences: {
                        accent: 'american',
                        pitch: 1.0,
                        speed: 1.0,
                        energy: 1.0
                    },
                    availableAccents: [
                        { id: 'american', name: 'American English', flag: '🇺🇸', lang: 'English' },
                        { id: 'uk', name: 'British English', flag: '🇬🇧', lang: 'English' },
                        { id: 'irish', name: 'Irish English', flag: '🇮🇪', lang: 'English' },
                        { id: 'indian', name: 'Indian English', flag: '🇮🇳', lang: 'English' },
                        { id: 'african', name: 'Nigerian English', flag: '🇳🇬', lang: 'English' },
                        { id: 'mexican', name: 'Mexican Spanish', flag: '🇲🇽', lang: 'Español' },
                        { id: 'french', name: 'French', flag: '🇫🇷', lang: 'Français' },
                        { id: 'italian', name: 'Italian', flag: '🇮🇹', lang: 'Italiano' },
                        { id: 'german', name: 'German', flag: '🇩🇪', lang: 'Deutsch' }
                    ]
                };
            },
            
            computed: {
                userName() {
                    if (!this.user) return 'Guest';
                    return this.user.first_name || this.user.username;
                },
                userInitials() {
                    if (!this.user) return 'G';
                    const first = this.user.first_name?.[0] || this.user.username[0];
                    const last = this.user.last_name?.[0] || '';
                    return (first + last).toUpperCase();
                },
                userQueries() {
                    return this.user?.profile?.queries_count || 0;
                },
                hasPreferenceChanges() {
                    if (!this.user?.profile) return false;
                    
                    return this.ttsPreferences.accent !== this.user.profile.tts_voice_type ||
                        this.ttsPreferences.pitch !== this.user.profile.tts_pitch ||
                        this.ttsPreferences.speed !== this.user.profile.tts_speed ||
                        this.ttsPreferences.energy !== this.user.profile.tts_energy;
                }
            },
            
            mounted() {
                this.checkAuthentication();
                this.requestMicrophonePermission();
                this.checkApiStatus();
		this.checkOllamaStatus();
                this.loadAvailableVoices();
                this.loadUserPreferences();

                setTimeout(() => this.playWelcomeMessage(), 1000);
                
                // Close menus when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                        this.showUserMenu = false;
                    }
                });
            },
            methods: {
                checkAuthentication() {
                    this.authToken = localStorage.getItem('authToken');
                    const userStr = localStorage.getItem('user');
                    
                    if (!this.authToken || !userStr) {
                        // Redirect to login
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    this.user = JSON.parse(userStr);
                },

		cleanTextForTTS(text) {
                    if (!text) return '';

                    return text
                        // Remove quotation marks
                        .replace(/['"'"\"]/g, '')
                        // Remove multiple spaces
                        .replace(/\s+/g, ' ')
                        // Remove special characters but keep basic punctuation
                        .replace(/[^\w\s.,!?;:()\-]/g, '')
                        // Trim whitespace
                        .trim();
                },
                
                async handleLogout() {
                    try {
                        await fetch(`${this.apiUrl}/auth/logout/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${this.authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    
                    // Clear local storage
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    
                    // Redirect to login
                    window.location.href = 'login.html';
                },
                
                async loadAvailableVoices() {
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/voices/`);
                        const data = await response.json();
                        if (data.success) {
                            this.availableVoices = data.voices;
                        }
                    } catch (error) {
                        console.error('Error loading voices:', error);
                    }
                },
                
                async requestMicrophonePermission() {
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                        console.log('Microphone access granted');
                    } catch (error) {
                        console.error('Microphone access denied:', error);
                    }
                },

                // Add these NEW methods for autocomplete
                async fetchAutocompleteSuggestions() {
                    if (!this.textQuery.trim() || this.textQuery.length < 2) {
                        this.autocompleteSuggestions = [];
                        this.showAutocomplete = false;
                        return;
                    }

                    this.isLoadingSuggestions = true;

                    try {
                        const response = await fetch(
                            `${this.apiUrl}/quotes/search/?q=${encodeURIComponent(this.textQuery)}&limit=3`,
                        );
                        const data = await response.json();

                        this.autocompleteSuggestions = data.results || [];
                        this.showAutocomplete = this.autocompleteSuggestions.length > 0;
                    } catch (error) {
                        console.error('Error fetching suggestions:', error);
                        this.autocompleteSuggestions = [];
                        this.showAutocomplete = false;
                    } finally {
                        this.isLoadingSuggestions = false;
                    }
                },

                selectSuggestion(quote) {
                    this.textQuery = quote.text.substring(0, 50) + '...'; // Preview of quote
                    this.quoteData = quote;
                    this.transcription = this.textQuery;
                    this.response = `${quote.author} once said: ${quote.text}`;
                    this.showAutocomplete = false;
                    
                    this.addToHistory({
                        query: this.textQuery,
                        response: this.response,
                        quote: quote,
                        timestamp: new Date().toLocaleTimeString()
                    });

                    this.synthesizeWithAccent(this.cleanTextForTTS(this.response));
                },

                hideAutocomplete() {
                    // Delay hiding to allow click events to fire
                    setTimeout(() => {
                        this.showAutocomplete = false;
                    }, 200);
                },

                async checkApiStatus() {
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/speaker/list/`);
                        this.apiStatus = response.ok;
                    } catch (error) {
                        this.apiStatus = false;
                    }
                },

		async checkOllamaStatus() {
                    try {
                        // First check if backend can reach Ollama
                        const ollamaUrl = this.apiUrl.includes('localhost')
                            ? 'http://localhost:11434/api/tags'
                            : 'http://wikiquote-ollama.germanywestcentral.azurecontainer.io:11434/api/tags';
                
                        const response = await fetch(ollamaUrl);
                        this.ollamaStatus = response.ok;
                    } catch (error) {
                        this.ollamaStatus = false;
                    }
                },

                async startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.mediaRecorder = new MediaRecorder(stream);
                        this.audioChunks = [];

                        this.mediaRecorder.ondataavailable = (event) => {
                            this.audioChunks.push(event.data);
                        };

                        this.mediaRecorder.onstop = async () => {
                            const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                            await this.processVoiceQuery(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };

                        this.mediaRecorder.start();
                        this.isRecording = true;
                    } catch (error) {
                        console.error('Error starting recording:', error);
                        alert('Could not access microphone. Please ensure permissions are granted.');
                    }
                },

                stopRecording() {
                    if (this.mediaRecorder && this.isRecording) {
                        this.mediaRecorder.stop();
                        this.isRecording = false;
                    }
                },

                toggleRecording() {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                },

                async processVoiceQuery(audioBlob) {
                    this.isProcessing = true;

                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'query.wav');

                    try {
                        const response = await fetch(`${this.apiUrl}/voice/query/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${this.authToken}`
                            },
                            body: formData,
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.transcription = data.transcription;
                            this.response = data.response_text;
                            this.quoteData = data.quote_data;

                            this.addToHistory({
                                query: data.transcription,
                                response: data.response_text,
                                quote: data.quote_data,
                                timestamp: new Date().toLocaleTimeString()
                            });

                            if (data.response_audio) {
                                this.playAudioFromBase64(data.response_audio);
                            }
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error processing voice query:', error);
                        alert('Failed to process voice query. Make sure the Django server is running.');
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async processTextQuery() {
                    if (!this.textQuery.trim()) return;

                    this.isProcessing = true;

                    try {
                        // Search for quote
                        const searchResponse = await fetch(
                            `${this.apiUrl}/quotes/search/?q=${encodeURIComponent(this.textQuery)}`, {
                                headers: {
                                    'Authorization': `Token ${this.authToken}`
                                }
                            }
                        );
                        const searchData = await searchResponse.json();

                        const quote = searchData.results && searchData.results.length > 0 
                            ? searchData.results[0] 
                            : null;

                        let responseText;
                        if (quote) {
                            responseText = `${quote.author} once said: ${quote.text}`;
                        } else {
                            responseText = "I couldn't find a relevant quote for that query.";
                        }

                        this.transcription = this.textQuery;
                        this.response = responseText;
                        this.quoteData = quote;

                        this.addToHistory({
                            query: this.textQuery,
                            response: responseText,
                            quote: quote,
                            timestamp: new Date().toLocaleTimeString()
                        });

                        await this.synthesizeWithAccent(this.cleanTextForTTS(responseText));

                        this.textQuery = '';
                    } catch (error) {
                        console.error('Error processing text query:', error);
                        alert('Failed to process query. Make sure the Django server is running.');
                    } finally {
                        this.isProcessing = false;
                    }
                },

                playAudioFromBase64(base64Audio) {
                    const audioBlob = this.base64ToBlob(base64Audio, 'audio/wav');
                    this.responseAudioUrl = URL.createObjectURL(audioBlob);
                    this.$refs.audioPlayer.src = this.responseAudioUrl;
                    this.$refs.audioPlayer.play();
                },

                playResponseAudio() {
                    if (this.$refs.audioPlayer) {
                        this.$refs.audioPlayer.play();
                    }
                },

                base64ToBlob(base64, mimeType) {
                    const byteCharacters = atob(base64);
                    const byteArrays = [];

                    for (let i = 0; i < byteCharacters.length; i += 512) {
                        const slice = byteCharacters.slice(i, i + 512);
                        const byteNumbers = new Array(slice.length);

                        for (let j = 0; j < slice.length; j++) {
                            byteNumbers[j] = slice.charCodeAt(j);
                        }

                        byteArrays.push(new Uint8Array(byteNumbers));
                    }

                    return new Blob(byteArrays, { type: mimeType });
                },

                addToHistory(item) {
                    this.history = [item, ...this.history].slice(0, 10);
                },

                selectAccent(accentId) {
                    this.ttsPreferences.accent = accentId;
                },
                
                async saveAccentPreferences() {
                    if (!this.user) {
                        alert('Please login first');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/tts/preferences/set/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${this.authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                voice_type: this.ttsPreferences.accent,
                                pitch: this.ttsPreferences.pitch,
                                speed: this.ttsPreferences.speed,
                                energy: this.ttsPreferences.energy
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Update local user object
                            this.user.profile.tts_voice_type = this.ttsPreferences.accent;
                            this.user.profile.tts_pitch = this.ttsPreferences.pitch;
                            this.user.profile.tts_speed = this.ttsPreferences.speed;
                            this.user.profile.tts_energy = this.ttsPreferences.energy;
                            
                            localStorage.setItem('user', JSON.stringify(this.user));
                            
                            alert(`Accent preferences saved! Responses will be in ${this.getAccentName(this.ttsPreferences.accent)}`);
                        } else {
                            alert('Failed to save preferences: ' + (data.error || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error saving preferences:', error);
                        alert('Failed to save preferences');
                    }
                },
                
                getAccentFlag(accentId) {
                    const accent = this.availableAccents.find(a => a.id === accentId);
                    return accent ? accent.flag : '🌍';
                },
                
                getAccentName(accentId) {
                    const accent = this.availableAccents.find(a => a.id === accentId);
                    return accent ? accent.name : 'Unknown';
                },
                
                async testCurrentAccent() {
                    if (!this.user?.profile?.tts_voice_type) return;
                    
                    await this.testSpecificAccent(this.user.profile.tts_voice_type);
                },
                async synthesizeWithAccent(text) {
                    try {
                        // Use the selected accent from ttsPreferences
                        const voiceType = this.ttsPreferences.accent || 'american';

			const cleanedText = this.cleanTextForTTS(text);

                        const response = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Token ${this.authToken}`
                            },
                            body: JSON.stringify({ 
                                text: cleanedText,
                                voice_type: voiceType,  // ✅ Use selected accent
                                pitch: this.ttsPreferences.pitch,
                                speed: this.ttsPreferences.speed,
                                energy: this.ttsPreferences.energy
                            })
                        });
                        
                        if (response.ok) {
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            if (this.$refs.audioPlayer) {
                                this.$refs.audioPlayer.src = audioUrl;
                                this.$refs.audioPlayer.play();
                            }
                        } else {
                            console.error('Failed to synthesize speech');
                        }
                    } catch (error) {
                        console.error('Error synthesizing speech:', error);
                    }
                },
                async testVoice() {
                    const testText = "Hello! This is how my voice will sound.";
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: this.cleanTextForTTS(testText),
                                voice_type: this.ttsPreferences.voice_type
                            })
                        });
                        
                        if (response.ok) {
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            if (this.$refs.audioPlayer) {
                                this.$refs.audioPlayer.src = audioUrl;
                                this.$refs.audioPlayer.play();
                            }
                        } else {
                            alert('Failed to generate test voice');
                        }
                    } catch (error) {
                        console.error('Error testing voice:', error);
                        alert('Failed to test voice');
                    }
                },
                
                async testSpecificAccent(accentId) {
                    const greetings = {
                        'american': 'Howdy! This is American English.',
                        'uk': 'Hello there! This is British English.',
                        'irish': 'Top of the morning! This is Irish English.',
                        'indian': 'Namaste! This is Indian English.',
                        'african': 'Hello! This is Nigerian English.',
                        'mexican': '¡Hola! Este es español mexicano.',
                        'french': 'Bonjour! Ceci est le français.',
                        'italian': 'Ciao! Questo è italiano.',
                        'german': 'Guten Tag! Das ist Deutsch.'
                    };
                    
                    const testText = greetings[accentId] || 'Hello! This is a test.';
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: this.cleanTextForTTS(testText),
                                voice_type: accentId
                            })
                        });
                        
                        if (response.ok) {
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            if (this.$refs.audioPlayer) {
                                this.$refs.audioPlayer.src = audioUrl;
                                this.$refs.audioPlayer.play();
                            }
                        }
                    } catch (error) {
                        console.error('Error testing accent:', error);
                    }
                },
                
                async testCurrentVoice() {
                    if (!this.user?.profile?.tts_voice_type) return;
                    
                    const testText = "This is your current personalized voice speaking.";
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: this.cleanTextForTTS(testText),
                                speaker_id: this.user.username
                            })
                        });
                        
                        if (response.ok) {
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            if (this.$refs.audioPlayer) {
                                this.$refs.audioPlayer.src = audioUrl;
                                this.$refs.audioPlayer.play();
                            }
                        }
                    } catch (error) {
                        console.error('Error testing current voice:', error);
                    }
                },

                async playWelcomeMessage() {
                    if (!this.user) return;
                    
                    const accent = this.user.profile?.tts_voice_type || 'american';
                    const name = this.user.first_name || this.user.username;
                    
                    const welcomeMessages = {
                        'american': `Welcome back, ${name}! Ready to explore some quotes?`,
                        'uk': `Welcome back, ${name}! Shall we discover some wisdom?`,
                        'irish': `Welcome back, ${name}! Ready for some grand quotes?`,
                        'mexican': `¡Bienvenido de nuevo, ${name}! ¿Listo para explorar citas?`,
                        'french': `Bon retour, ${name}! Prêt à explorer des citations?`,
                        'italian': `Bentornato, ${name}! Pronto per esplorare citazioni?`,
                        'german': `Willkommen zurück, ${name}! Bereit für Zitate?`
                    };
                    
                    const message = welcomeMessages[accent] || welcomeMessages['american'];
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: message, voice_type: accent })
                        });
                        
                        if (response.ok) {
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            if (this.$refs.audioPlayer) {
                                this.$refs.audioPlayer.src = audioUrl;
                                this.$refs.audioPlayer.play();
                            }
                        }
                    } catch (error) {
                        console.error('Error playing welcome:', error);
                    }
                },
                
                loadCurrentPreferences() {
                    if (this.user?.profile) {
                        this.ttsPreferences.voice_type = this.user.profile.tts_voice_type || 'american';
                        this.ttsPreferences.pitch = this.user.profile.tts_pitch || 1.0;
                        this.ttsPreferences.speed = this.user.profile.tts_speed || 1.0;
                        this.ttsPreferences.energy = this.user.profile.tts_energy || 1.0;
                    }
                    this.showProfileModal = false;
                },
                loadUserPreferences() {
                    if (this.user?.profile) {
                        this.ttsPreferences.accent = this.user.profile.tts_voice_type || 'american';
                        this.ttsPreferences.pitch = this.user.profile.tts_pitch || 1.0;
                        this.ttsPreferences.speed = this.user.profile.tts_speed || 1.0;
                        this.ttsPreferences.energy = this.user.profile.tts_energy || 1.0;
                    }
                },
                
                formatDate(dateStr) {
                    if (!dateStr) return 'Never';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diff = now - date;
                    
                    // Less than 1 minute
                    if (diff < 60000) return 'Just now';
                    
                    // Less than 1 hour
                    if (diff < 3600000) {
                        const mins = Math.floor(diff / 60000);
                        return `${mins} min ago`;
                    }
                    
                    // Less than 24 hours
                    if (diff < 86400000) {
                        const hours = Math.floor(diff / 3600000);
                        return `${hours}h ago`;
                    }
                    
                    // Less than 7 days
                    if (diff < 604800000) {
                        const days = Math.floor(diff / 86400000);
                        return `${days}d ago`;
                    }
                    
                    // Format as date
                    return date.toLocaleDateString();
                },
                // Chatbot Methods
                openChat() {
                    this.chatOpen = true;
                    this.unreadMessages = 0;
                    this.$nextTick(() => {
                        if (this.$refs.chatInputField) {
                            this.$refs.chatInputField.focus();
                        }
                        this.scrollChatToBottom();
                    });
                },
                
                closeChat() {
                    this.chatOpen = false;
                },
                
                async sendChatMessage() {
                    if (!this.chatInput.trim() || this.chatLoading) return;
                    
                    const userMessage = {
                        role: 'user',
                        content: this.chatInput,
                        timestamp: new Date()
                    };
                    
                    this.chatMessages.push(userMessage);
                    const query = this.chatInput;
                    this.chatInput = '';
                    this.chatLoading = true;
                    
                    this.$nextTick(() => this.scrollChatToBottom());
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/quotes/chat/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': this.authToken ? `Token ${this.authToken}` : ''
                            },
                            body: JSON.stringify({
                                query: query,
                                username: this.user?.first_name || this.user?.username || 'friend',
                                accent: this.chatAccent
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            const assistantMessage = {
                                role: 'assistant',
                                content: data.response,
                                quotes: data.quotes || [],
                                method: data.method,
                                timestamp: new Date()
                            };
                            
                            this.chatMessages.push(assistantMessage);
                            
                            // If chat is closed, increment unread counter
                            if (!this.chatOpen) {
                                this.unreadMessages++;
                            }
                        } else {
                            throw new Error(data.error || 'Failed to get response');
                        }
                    } catch (error) {
                        console.error('Chat error:', error);
                        const errorMessage = {
                            role: 'assistant',
                            content: "Sorry, I'm having trouble connecting. Please try again! 😅",
                            timestamp: new Date()
                        };
                        this.chatMessages.push(errorMessage);
                    } finally {
                        this.chatLoading = false;
                        this.$nextTick(() => this.scrollChatToBottom());
                    }
                },
                
                sendQuickQuestion(question) {
                    this.chatInput = question;
                    this.sendChatMessage();
                },
                
                async toggleChatRecording() {
                    if (this.chatRecording) {
                        this.stopChatRecording();
                    } else {
                        await this.startChatRecording();
                    }
                },
                
                async startChatRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.chatMediaRecorder = new MediaRecorder(stream);
                        this.chatAudioChunks = [];
                        
                        this.chatMediaRecorder.ondataavailable = (event) => {
                            this.chatAudioChunks.push(event.data);
                        };
                        
                        this.chatMediaRecorder.onstop = async () => {
                            const audioBlob = new Blob(this.chatAudioChunks, { type: 'audio/wav' });
                            await this.processChatVoiceQuery(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };
                        
                        this.chatMediaRecorder.start();
                        this.chatRecording = true;
                    } catch (error) {
                        console.error('Error starting chat recording:', error);
                        alert('Could not access microphone. Please ensure permissions are granted.');
                    }
                },
                
                stopChatRecording() {
                    if (this.chatMediaRecorder && this.chatRecording) {
                        this.chatMediaRecorder.stop();
                        this.chatRecording = false;
                    }
                },
                
                async processChatVoiceQuery(audioBlob) {
                    this.chatLoading = true;
                    
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'query.wav');
                    
                    try {
                        // First, transcribe the audio
                        const asrResponse = await fetch(`${this.apiUrl}/voice/asr/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': this.authToken ? `Token ${this.authToken}` : ''
                            },
                            body: formData
                        });
                        
                        const asrData = await asrResponse.json();
                        
                        if (asrData.success && asrData.transcription) {
                            // Add user message with transcription
                            const userMessage = {
                                role: 'user',
                                content: asrData.transcription,
                                timestamp: new Date()
                            };
                            this.chatMessages.push(userMessage);
                            this.$nextTick(() => this.scrollChatToBottom());
                            
                            // Now send to RAG chat endpoint
                            const chatResponse = await fetch(`${this.apiUrl}/quotes/chat/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': this.authToken ? `Token ${this.authToken}` : ''
                                },
                                body: JSON.stringify({
                                    query: asrData.transcription,
                                    username: this.user?.first_name || this.user?.username || 'friend',
                                    accent: this.chatAccent
                                })
                            });
                            
                            const chatData = await chatResponse.json();
                            
                            if (chatData.success) {
                                const assistantMessage = {
                                    role: 'assistant',
                                    content: chatData.response,
                                    quotes: chatData.quotes || [],
                                    method: chatData.method,
                                    timestamp: new Date()
                                };
                                this.chatMessages.push(assistantMessage);
                                
                                // Synthesize speech response
                                const ttsResponse = await fetch(`${this.apiUrl}/voice/synthesize/`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ 
                                        text: chatData.response,
                                        voice_type: this.chatAccent
                                    })
                                });
                                
                                if (ttsResponse.ok) {
                                    const audioBlob = await ttsResponse.blob();
                                    const audioUrl = URL.createObjectURL(audioBlob);
                                    if (this.$refs.audioPlayer) {
                                        this.$refs.audioPlayer.src = audioUrl;
                                        this.$refs.audioPlayer.play();
                                    }
                                }
                            }
                        } else {
                            throw new Error('Failed to transcribe audio');
                        }
                    } catch (error) {
                        console.error('Error processing voice query:', error);
                        const errorMessage = {
                            role: 'assistant',
                            content: "Sorry, I couldn't understand that. Please try again! 😅",
                            timestamp: new Date()
                        };
                        this.chatMessages.push(errorMessage);
                    } finally {
                        this.chatLoading = false;
                        this.$nextTick(() => this.scrollChatToBottom());
                    }
                },
                
                clearChatHistory() {
                    if (confirm('Clear all chat messages?')) {
                        this.chatMessages = [
                            {
                                role: 'assistant',
                                content: "Chat cleared! Ask me anything about quotes! 💭",
                                timestamp: new Date()
                            }
                        ];
                    }
                },
                
                scrollChatToBottom() {
                    if (this.$refs.chatMessages) {
                        this.$nextTick(() => {
                            this.$refs.chatMessages.scrollTop = this.$refs.chatMessages.scrollHeight;
                        });
                    }
                },
                
                formatMessageTime(date) {
                    const now = new Date();
                    const diff = now - date;
                    
                    // Less than 1 minute
                    if (diff < 60000) return 'Just now';
                    
                    // Less than 1 hour
                    if (diff < 3600000) {
                        const mins = Math.floor(diff / 60000);
                        return `${mins}m ago`;
                    }
                    
                    // Show time
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
            },
            watch: {
                textQuery(newValue) {
                    // Debounce: wait 300ms after user stops typing
                    clearTimeout(this.autocompleteTimeout);
                    this.autocompleteTimeout = setTimeout(() => {
                        this.fetchAutocompleteSuggestions();
                    }, 300);
                }
            },
        }).mount('#app');
    </script>
</body>
</html>
