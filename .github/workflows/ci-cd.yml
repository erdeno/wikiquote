name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Run Tests
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Django tests
      env:
        NEO4J_URI: ${{ secrets.NEO4J_URI }}
        NEO4J_USER: ${{ secrets.NEO4J_USER }}
        NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DJANGO_SETTINGS_MODULE: backend.settings
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest -v --tb=short
      continue-on-error: true

  # Job 2: Build Docker Images
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Backend image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/wikiquote-backend:latest
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/wikiquote-backend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/wikiquote-backend:buildcache,mode=max
    
    - name: Build and push Frontend image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/wikiquote-frontend:latest

  # Job 3: Deploy to Azure Container Instances
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy Backend to Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: wikiquote-rg
        name: wikiquote-backend
        image: ${{ secrets.DOCKER_USERNAME }}/wikiquote-backend:latest
        location: germanywestcentral
        dns-name-label: wikiquote-backend
        ports: 8000
        environment-variables: NEO4J_URI=${{ secrets.NEO4J_URI }} NEO4J_USER=${{ secrets.NEO4J_USER }} NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }} DB_NAME=${{ secrets.DB_NAME }} DB_USER=${{ secrets.DB_USER }} DB_PASSWORD=${{ secrets.DB_PASSWORD }} DB_HOST=${{ secrets.DB_HOST }} DB_PORT=${{ secrets.DB_PORT }} DJANGO_SETTINGS_MODULE=backend.settings PYTHONUNBUFFERED=1 SECRET_KEY=${{ secrets.SECRET_KEY }}
        cpu: 1
        memory: 2
    
    - name: Deploy Frontend to Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: wikiquote-rg
        name: wikiquote-frontend
        image: ${{ secrets.DOCKER_USERNAME }}/wikiquote-frontend:latest
        location: germanywestcentral
        dns-name-label: wikiquote-frontend
        ports: 8080
        cpu: 0.5
        memory: 1
    
    - name: Deploy Ollama to Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: wikiquote-rg
        name: wikiquote-ollama
        image: ollama/ollama:latest
        location: germanywestcentral
        dns-name-label: wikiquote-ollama
        ports: 11434
        cpu: 2
        memory: 4
