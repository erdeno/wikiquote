# Job 3: Deploy to Azure Container Instances
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy Backend to Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: wikiquote-rg
        name: wikiquote-backend
        image: ${{ secrets.DOCKER_USERNAME }}/wikiquote-backend:latest
        dns-name-label: wikiquote-backend-${{ github.run_number }}
        ports: 8000
        environment-variables: |
          NEO4J_URI=${{ secrets.NEO4J_URI }}
          NEO4J_USER=${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}
          DJANGO_SETTINGS_MODULE=backend.settings
          PYTHONUNBUFFERED=1
        cpu: 1
        memory: 2
    
    - name: Deploy Frontend to Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: wikiquote-rg
        name: wikiquote-frontend
        image: ${{ secrets.DOCKER_USERNAME }}/wikiquote-frontend:latest
        dns-name-label: wikiquote-frontend-${{ github.run_number }}
        ports: 8080
        cpu: 0.5
        memory: 1
    
    - name: Deploy Ollama to Azure Container Instances
      uses: azure/aci-deploy@v1
      with:
        resource-group: wikiquote-rg
        name: wikiquote-ollama
        image: ollama/ollama:latest
        dns-name-label: wikiquote-ollama-${{ github.run_number }}
        ports: 11434
        cpu: 2
        memory: 4
